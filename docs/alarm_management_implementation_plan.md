# 报警管理和报警触发完善实施计划

## 📋 项目概述

本计划旨在完善AISecurityVision系统的报警管理和报警触发功能，实现HTTP、WebSocket、MQTT三种推送方式的统一管理，提供完整的前端配置界面和后端API支持。

## 🎯 实施阶段

### ✅ 第一阶段：核心架构完善 (已完成)

#### 1.1 TaskManager集成AlarmTrigger
- [x] 在TaskManager中添加AlarmTrigger管理
- [x] 更新锁层次结构，添加ALARM_TRIGGER级别
- [x] 实现AlarmTrigger的初始化和清理
- [x] 修改AlertController使用TaskManager的AlarmTrigger实例

#### 1.2 VideoPipeline集成优化
- [x] 移除VideoPipeline中的独立AlarmTrigger实例
- [x] 修改报警触发逻辑使用TaskManager的统一实例
- [x] 确保报警触发的线程安全性

### 🚧 第二阶段：API接口完善 (进行中)

#### 2.1 后端API扩展
- [x] 添加报警配置的CRUD操作接口
  - `GET /api/alarms/config` - 获取所有配置
  - `POST /api/alarms/config` - 添加新配置
  - `GET /api/alarms/config/{id}` - 获取单个配置
  - `PUT /api/alarms/config/{id}` - 更新配置
  - `DELETE /api/alarms/config/{id}` - 删除配置
- [x] 实现配置序列化和反序列化
- [x] 添加配置验证和错误处理

#### 2.2 前端API服务
- [x] 扩展apiService添加报警配置管理接口
- [x] 添加配置测试和状态查询接口

### 🚧 第三阶段：前端界面开发 (进行中)

#### 3.1 报警配置管理界面
- [x] 创建AlarmConfig.vue页面
- [x] 实现配置列表展示和管理
- [x] 支持HTTP、WebSocket、MQTT三种配置类型
- [x] 添加配置表单验证和错误处理
- [x] 实现配置的增删改查操作

#### 3.2 导航和路由
- [x] 添加报警配置页面到路由系统
- [x] 更新导航菜单添加报警配置入口
- [x] 添加人员统计页面到导航菜单

#### 3.3 状态监控
- [x] 实现报警系统状态实时监控
- [x] 显示待处理、成功、失败报警数量
- [x] 显示平均推送延迟

### 📋 第四阶段：功能增强 (待实施)

#### 4.1 报警规则管理
- [ ] 实现基于摄像头的报警规则配置
- [ ] 支持按检测类型、置信度、时间段等条件触发
- [ ] 添加报警去重和频率限制

#### 4.2 报警模板系统
- [ ] 实现报警消息模板配置
- [ ] 支持动态变量替换（摄像头名称、时间、检测类型等）
- [ ] 提供多种预设模板

#### 4.3 报警历史和统计
- [ ] 实现报警历史记录存储
- [ ] 添加报警统计分析功能
- [ ] 提供报警趋势图表

### 🔧 第五阶段：高级功能 (待实施)

#### 5.1 报警升级机制
- [ ] 实现报警优先级自动升级
- [ ] 支持多级报警通知
- [ ] 添加报警确认和处理流程

#### 5.2 集成第三方服务
- [ ] 支持钉钉、企业微信等即时通讯工具
- [ ] 集成邮件通知服务
- [ ] 支持短信通知（需第三方服务）

#### 5.3 智能报警
- [ ] 基于AI的误报过滤
- [ ] 报警模式学习和优化
- [ ] 异常检测和预警

## 🛠️ 技术实现细节

### 架构设计
```
TaskManager (单例)
├── AlarmTrigger (统一管理)
│   ├── HTTP推送
│   ├── WebSocket广播
│   └── MQTT发布
├── VideoPipeline (多实例)
│   └── 报警触发 → TaskManager.AlarmTrigger
└── API Controllers
    └── AlertController → TaskManager.AlarmTrigger
```

### 数据流程
```
检测结果 → VideoPipeline → AlarmTrigger → 多通道推送
                                      ├── HTTP POST
                                      ├── WebSocket Broadcast
                                      └── MQTT Publish
```

### 配置管理
- 配置存储：内存 + 可选数据库持久化
- 配置验证：前端表单验证 + 后端业务验证
- 配置热更新：支持运行时配置修改

## 📊 测试计划

### 单元测试
- [ ] AlarmTrigger核心功能测试
- [ ] 配置序列化/反序列化测试
- [ ] API接口功能测试

### 集成测试
- [ ] 端到端报警流程测试
- [ ] 多通道并发推送测试
- [ ] 配置管理界面测试

### 性能测试
- [ ] 高频报警处理性能测试
- [ ] 多摄像头并发报警测试
- [ ] 内存和CPU使用率监控

## 🚀 部署和维护

### 部署要求
- 确保WebSocket端口可访问（默认8081）
- 配置MQTT broker连接（如需要）
- 检查HTTP推送目标的网络连通性

### 监控指标
- 报警处理延迟
- 推送成功率
- 系统资源使用
- 错误日志监控

### 维护建议
- 定期清理报警历史数据
- 监控配置变更日志
- 备份重要报警配置
- 定期测试报警通道可用性

## 📝 文档更新

### 用户文档
- [ ] 报警配置使用指南
- [ ] 常见问题解答
- [ ] 最佳实践建议

### 开发文档
- [ ] API接口文档更新
- [ ] 架构设计文档
- [ ] 代码注释完善

## 🎉 预期收益

1. **统一管理**：所有报警配置集中管理，避免重复配置
2. **多通道支持**：同时支持HTTP、WebSocket、MQTT推送
3. **实时监控**：提供报警系统状态实时监控
4. **易于扩展**：模块化设计便于添加新的推送方式
5. **用户友好**：直观的Web界面简化配置过程

## ⚠️ 注意事项

1. **向后兼容**：确保现有功能不受影响
2. **性能影响**：监控报警处理对系统性能的影响
3. **安全考虑**：保护敏感配置信息（如密码、Token）
4. **错误处理**：完善的错误处理和恢复机制
5. **日志记录**：详细的操作日志便于问题排查
