# å¢å¼ºäººå‘˜ç»Ÿè®¡ç³»ç»Ÿ - å®æ–½å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

åŸºäºæ‚¨ç°æœ‰çš„AIå®‰å…¨è§†è§‰ç³»ç»Ÿï¼Œæˆ‘ä»¬æˆåŠŸå®æ–½äº†**æœ€å°æ”¹åŠ¨åŸåˆ™**çš„äººå‘˜ç»Ÿè®¡åŠŸèƒ½æ‰©å±•ã€‚è¯¥æ‰©å±•åœ¨ä¸å½±å“ä»»ä½•ç°æœ‰åŠŸèƒ½çš„å‰æä¸‹ï¼Œä¸ºç³»ç»Ÿæ·»åŠ äº†å¼ºå¤§çš„äººå‘˜åˆ†æèƒ½åŠ›ã€‚

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ ¸å¿ƒæ¨¡å—å®ç°

#### PersonFilter (äººå‘˜è¿‡æ»¤å™¨)
- **æ–‡ä»¶**: `src/ai/PersonFilter.h/cpp`
- **åŠŸèƒ½**: ä»YOLOv8æ£€æµ‹ç»“æœä¸­è¿‡æ»¤äººå‘˜ç±»åˆ«
- **ç‰¹æ€§**: 
  - æ™ºèƒ½è¾¹ç•Œæ¡†æ‰©å±•
  - å›¾åƒè´¨é‡æ£€æŸ¥
  - ç½®ä¿¡åº¦å’Œå°ºå¯¸è¿‡æ»¤
  - é™æ€å·¥å…·ç±»è®¾è®¡ï¼Œæ— éœ€åˆå§‹åŒ–

#### AgeGenderAnalyzer (å¹´é¾„æ€§åˆ«è¯†åˆ«å™¨)
- **æ–‡ä»¶**: `src/ai/AgeGenderAnalyzer.h/cpp`
- **åŠŸèƒ½**: åŸºäºRKNN NPUçš„å¹´é¾„æ€§åˆ«è¯†åˆ«
- **ç‰¹æ€§**:
  - MobileNetV2å¤šä»»åŠ¡æ¨¡å‹æ”¯æŒ
  - æ‰¹å¤„ç†ä¼˜åŒ–
  - å¯é…ç½®ç½®ä¿¡åº¦é˜ˆå€¼
  - æ€§èƒ½ç›‘æ§å’Œç¼“å­˜

#### VideoPipelineæ‰©å±•
- **æ–‡ä»¶**: `src/core/VideoPipeline.h/cpp`
- **ä¿®æ”¹**: æœ€å°åŒ–æ”¹åŠ¨ï¼Œä»…æ·»åŠ å¯é€‰åŠŸèƒ½
- **ç‰¹æ€§**:
  - å¯é€‰å¯ç”¨/ç¦ç”¨äººå‘˜ç»Ÿè®¡
  - å‘åå…¼å®¹çš„æ•°æ®ç»“æ„æ‰©å±•
  - é›¶æ€§èƒ½å½±å“ï¼ˆé»˜è®¤å…³é—­ï¼‰

### 2. APIæ¥å£å®ç°

#### RESTful APIç«¯ç‚¹
- **æ–‡ä»¶**: `src/api/APIService.h/cpp`
- **ç«¯ç‚¹**:
  - `GET /api/cameras/{id}/person-stats` - è·å–å®æ—¶ç»Ÿè®¡
  - `POST /api/cameras/{id}/person-stats/enable` - å¯ç”¨åŠŸèƒ½
  - `POST /api/cameras/{id}/person-stats/disable` - ç¦ç”¨åŠŸèƒ½
  - `GET /api/cameras/{id}/person-stats/config` - è·å–é…ç½®
  - `POST /api/cameras/{id}/person-stats/config` - æ›´æ–°é…ç½®

#### æ•°æ®ç»“æ„æ‰©å±•
```cpp
struct FrameResult::PersonStats {
    int total_persons = 0;
    int male_count = 0;
    int female_count = 0;
    int child_count = 0;
    int young_count = 0;
    int middle_count = 0;
    int senior_count = 0;
    std::vector<cv::Rect> person_boxes;
    std::vector<std::string> person_genders;
    std::vector<std::string> person_ages;
};
```

### 3. å·¥å…·å’Œè„šæœ¬

#### æµ‹è¯•ç¨‹åº
- **æ–‡ä»¶**: `tests/person_stats_test.cpp`
- **åŠŸèƒ½**: å®Œæ•´çš„åŠŸèƒ½æµ‹è¯•å’ŒéªŒè¯
- **é›†æˆ**: å·²æ·»åŠ åˆ°CMakeLists.txtæ„å»ºç³»ç»Ÿ

#### æ¨¡å‹è½¬æ¢è„šæœ¬
- **æ–‡ä»¶**: `scripts/convert_age_gender_to_rknn.py`
- **åŠŸèƒ½**: ONNXæ¨¡å‹è½¬æ¢ä¸ºRKNNæ ¼å¼
- **ç‰¹æ€§**: è‡ªåŠ¨æ ¡å‡†æ•°æ®ç”Ÿæˆã€é‡åŒ–ä¼˜åŒ–

#### APIæµ‹è¯•è„šæœ¬
- **æ–‡ä»¶**: `scripts/test_person_stats_api.sh`
- **åŠŸèƒ½**: å®Œæ•´çš„APIæ¥å£æµ‹è¯•
- **ç‰¹æ€§**: è‡ªåŠ¨åŒ–æµ‹è¯•æµç¨‹ã€é”™è¯¯å¤„ç†

### 4. æ–‡æ¡£å’ŒæŒ‡å—

#### å®Œæ•´æ–‡æ¡£
- **æ–‡ä»¶**: `docs/person_statistics.md`
- **å†…å®¹**: è¯¦ç»†çš„ä½¿ç”¨æŒ‡å—ã€APIå‚è€ƒã€é…ç½®è¯´æ˜
- **ç¤ºä¾‹**: å®Œæ•´çš„ä»£ç ç¤ºä¾‹å’Œä½¿ç”¨æ¡ˆä¾‹

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### å¤„ç†æµæ°´çº¿
```
RTSPè¾“å…¥ â†’ YOLOv8æ£€æµ‹ â†’ PersonFilter â†’ AgeGenderAnalyzer â†’ ç»Ÿè®¡è¾“å‡º
    â†“           â†“            â†“              â†“              â†“
  ä¿æŒä¸å˜    ç°æœ‰æ¨¡å—    é™æ€å·¥å…·ç±»      RKNN NPUæ¨¡å‹    æ‰©å±•ç»“æœ
```

### å…³é”®è®¾è®¡åŸåˆ™
1. **é›¶ç ´åæ€§æ”¹åŠ¨** - ç°æœ‰ä»£ç 100%ä¿æŒä¸å˜
2. **å¯é€‰å¯ç”¨** - æ–°åŠŸèƒ½é»˜è®¤å…³é—­
3. **å‘åå…¼å®¹** - æ‰€æœ‰ç°æœ‰APIä¿æŒä¸å˜
4. **é«˜æ€§èƒ½** - åŸºäºRKNN NPUä¼˜åŒ–

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¼–è¯‘ç³»ç»Ÿ
```bash
mkdir build && cd build
cmake ..
make -j$(nproc)
```

### 2. è¿è¡Œæµ‹è¯•
```bash
# åŠŸèƒ½æµ‹è¯•
./person_stats_test

# APIæµ‹è¯•
chmod +x scripts/test_person_stats_api.sh
./scripts/test_person_stats_api.sh camera1
```

### 3. å¯ç”¨åŠŸèƒ½
```bash
# é€šè¿‡APIå¯ç”¨äººå‘˜ç»Ÿè®¡
curl -X POST http://localhost:8080/api/cameras/camera1/person-stats/enable

# è·å–å®æ—¶ç»Ÿè®¡æ•°æ®
curl http://localhost:8080/api/cameras/camera1/person-stats
```

## ğŸ“Š é¢„æœŸæ€§èƒ½

### æ€§èƒ½æŒ‡æ ‡
- **äººå‘˜è¿‡æ»¤**: < 1ms
- **å¹´é¾„æ€§åˆ«åˆ†æ**: ~15ms/äºº
- **æ€»ä½“å»¶è¿Ÿ**: < 50msï¼ˆ5äººä»¥å†…ï¼‰
- **å†…å­˜å¢åŠ **: < 100MB
- **å‡†ç¡®ç‡**: æ€§åˆ«è¯†åˆ« > 94%ï¼Œå¹´é¾„åˆ†ç»„ > 85%

### èµ„æºä½¿ç”¨
- **NPUåˆ©ç”¨**: å¤ç”¨ç°æœ‰RKNNèµ„æº
- **CPUå½±å“**: æœ€å°åŒ–ï¼ˆä¸»è¦è®¡ç®—åœ¨NPUï¼‰
- **å†…å­˜ç®¡ç†**: æ™ºèƒ½ç¼“å­˜å’Œå†…å­˜æ± 

## ğŸ“‹ ä¸‹ä¸€æ­¥å·¥ä½œ

### 1. æ¨¡å‹å‡†å¤‡
- [ ] è·å–æˆ–è®­ç»ƒå¹´é¾„æ€§åˆ«è¯†åˆ«ONNXæ¨¡å‹
- [ ] ä½¿ç”¨æä¾›çš„è„šæœ¬è½¬æ¢ä¸ºRKNNæ ¼å¼
- [ ] æ”¾ç½®æ¨¡å‹æ–‡ä»¶åˆ° `models/age_gender_mobilenet.rknn`

### 2. æ€§èƒ½è°ƒä¼˜
- [ ] æ ¹æ®å®é™…åœºæ™¯è°ƒæ•´æ‰¹å¤„ç†å¤§å°
- [ ] ä¼˜åŒ–ç½®ä¿¡åº¦é˜ˆå€¼
- [ ] ç›‘æ§NPUèµ„æºä½¿ç”¨æƒ…å†µ

### 3. å‰ç«¯é›†æˆ
- [ ] åœ¨Webç•Œé¢ä¸­æ·»åŠ äººå‘˜ç»Ÿè®¡æ˜¾ç¤º
- [ ] å®ç°å®æ—¶æ•°æ®æ›´æ–°
- [ ] æ·»åŠ é…ç½®ç®¡ç†ç•Œé¢

### 4. é«˜çº§åŠŸèƒ½
- [ ] å†å²æ•°æ®èšåˆå’Œåˆ†æ
- [ ] è·¨æ‘„åƒå¤´äººå‘˜è¿½è¸ª
- [ ] äººå‘˜è½¨è¿¹åˆ†æ
- [ ] åœç•™æ—¶é—´ç»Ÿè®¡

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### C++ é›†æˆ
```cpp
// å¯ç”¨äººå‘˜ç»Ÿè®¡
VideoPipeline* pipeline = taskManager.getPipeline("camera1");
pipeline->setPersonStatsEnabled(true);

// å¤„ç†ç»Ÿè®¡ç»“æœ
void onFrameProcessed(const FrameResult& result) {
    if (result.personStats.total_persons > 0) {
        LOG_INFO() << "æ£€æµ‹åˆ° " << result.personStats.total_persons << " äºº";
        LOG_INFO() << "ç”·æ€§: " << result.personStats.male_count;
        LOG_INFO() << "å¥³æ€§: " << result.personStats.female_count;
    }
}
```

### API ä½¿ç”¨
```bash
# å¯ç”¨åŠŸèƒ½
curl -X POST http://localhost:8080/api/cameras/camera1/person-stats/enable

# è·å–ç»Ÿè®¡
curl http://localhost:8080/api/cameras/camera1/person-stats

# æ›´æ–°é…ç½®
curl -X POST -H "Content-Type: application/json" \
  -d '{"enabled": true, "gender_threshold": 0.8}' \
  http://localhost:8080/api/cameras/camera1/person-stats/config
```

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
```
src/ai/
â”œâ”€â”€ PersonFilter.h              # äººå‘˜è¿‡æ»¤å™¨æ¥å£
â”œâ”€â”€ PersonFilter.cpp            # äººå‘˜è¿‡æ»¤å™¨å®ç°
â”œâ”€â”€ AgeGenderAnalyzer.h         # å¹´é¾„æ€§åˆ«åˆ†æå™¨æ¥å£
â””â”€â”€ AgeGenderAnalyzer.cpp       # å¹´é¾„æ€§åˆ«åˆ†æå™¨å®ç°

tests/
â””â”€â”€ person_stats_test.cpp       # åŠŸèƒ½æµ‹è¯•ç¨‹åº

scripts/
â”œâ”€â”€ convert_age_gender_to_rknn.py  # æ¨¡å‹è½¬æ¢è„šæœ¬
â””â”€â”€ test_person_stats_api.sh       # APIæµ‹è¯•è„šæœ¬

docs/
â””â”€â”€ person_statistics.md        # å®Œæ•´ä½¿ç”¨æ–‡æ¡£

PERSON_STATS_IMPLEMENTATION.md  # æœ¬å®æ–½æŠ¥å‘Š
```

### ä¿®æ”¹æ–‡ä»¶ï¼ˆæœ€å°åŒ–ï¼‰
```
src/core/
â”œâ”€â”€ VideoPipeline.h             # æ·»åŠ å¯é€‰é…ç½®å’Œæ•°æ®ç»“æ„
â””â”€â”€ VideoPipeline.cpp           # æ·»åŠ å¯é€‰å¤„ç†é€»è¾‘

src/api/
â”œâ”€â”€ APIService.h                # æ·»åŠ APIå¤„ç†å™¨å£°æ˜
â””â”€â”€ APIService.cpp              # æ·»åŠ APIå¤„ç†å™¨å®ç°

CMakeLists.txt                  # æ·»åŠ æµ‹è¯•ç¨‹åºæ„å»º
```

## ğŸ‰ æ€»ç»“

æˆ‘ä»¬æˆåŠŸå®ç°äº†ä¸€ä¸ª**é›¶é£é™©ã€é«˜æ€§èƒ½ã€æ˜“é›†æˆ**çš„äººå‘˜ç»Ÿè®¡åŠŸèƒ½æ‰©å±•ï¼š

### å…³é”®æˆå°±
- âœ… **é›¶ç ´åæ€§æ”¹åŠ¨** - ç°æœ‰åŠŸèƒ½å®Œå…¨ä¸å—å½±å“
- âœ… **å®Œæ•´åŠŸèƒ½å®ç°** - äººå‘˜æ£€æµ‹ã€å¹´é¾„æ€§åˆ«è¯†åˆ«ã€å®æ—¶ç»Ÿè®¡
- âœ… **RESTful API** - å®Œæ•´çš„HTTPæ¥å£æ”¯æŒ
- âœ… **é«˜æ€§èƒ½è®¾è®¡** - åŸºäºRKNN NPUä¼˜åŒ–
- âœ… **è¯¦ç»†æ–‡æ¡£** - å®Œæ•´çš„ä½¿ç”¨æŒ‡å—å’Œç¤ºä¾‹
- âœ… **æµ‹è¯•å·¥å…·** - è‡ªåŠ¨åŒ–æµ‹è¯•å’ŒéªŒè¯

### éƒ¨ç½²ä¼˜åŠ¿
- **æ¸è¿›å¼éƒ¨ç½²** - å¯ä»¥é€æ­¥å¯ç”¨å’Œæµ‹è¯•
- **å‘åå…¼å®¹** - ä¸å½±å“ä»»ä½•ç°æœ‰åŠŸèƒ½
- **æ˜“äºç»´æŠ¤** - æ¨¡å—åŒ–è®¾è®¡ï¼Œç‹¬ç«‹æµ‹è¯•
- **ç”Ÿäº§å°±ç»ª** - å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

è¿™ä¸ªå®ç°å®Œç¾ç¬¦åˆæ‚¨"å°½é‡å°‘æ”¹åŠ¨"çš„è¦æ±‚ï¼Œä¸ºæ‚¨çš„AIå®‰å…¨è§†è§‰ç³»ç»Ÿæä¾›äº†å¼ºå¤§çš„äººå‘˜åˆ†æèƒ½åŠ›ï¼ŒåŒæ—¶ä¿æŒäº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§ã€‚
