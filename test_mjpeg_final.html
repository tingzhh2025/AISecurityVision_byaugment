<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJPEG流最终测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .stream-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .stream-item {
            flex: 1;
            min-width: 300px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        .stream-header {
            background: #f8f9fa;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        .stream-content {
            padding: 10px;
            text-align: center;
        }
        .stream-image {
            max-width: 100%;
            height: 200px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .stream-url {
            font-size: 12px;
            color: #666;
            margin: 10px 0;
            word-break: break-all;
        }
        .status {
            padding: 8px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .api-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .api-result {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎥 AI安全视觉系统 - MJPEG流最终测试</h1>
        
        <!-- 直接MJPEG流测试 -->
        <div class="test-section">
            <div class="test-title">📡 直接MJPEG流测试</div>
            <div class="stream-container">
                <div class="stream-item">
                    <div class="stream-header">后端MJPEG流 (端口8161)</div>
                    <div class="stream-content">
                        <img 
                            id="direct-stream" 
                            class="stream-image" 
                            alt="Direct MJPEG Stream"
                            onload="handleStreamLoad('direct-stream')"
                            onerror="handleStreamError('direct-stream')"
                        />
                        <div class="stream-url">http://127.0.0.1:8161/stream.mjpg</div>
                        <div id="direct-status" class="status loading">等待加载...</div>
                        <button onclick="testDirectStream()">测试直接流</button>
                        <button onclick="refreshDirectStream()">刷新流</button>
                    </div>
                </div>
                
                <div class="stream-item">
                    <div class="stream-header">前端代理流 (端口3001)</div>
                    <div class="stream-content">
                        <img 
                            id="proxy-stream" 
                            class="stream-image" 
                            alt="Proxy MJPEG Stream"
                            onload="handleStreamLoad('proxy-stream')"
                            onerror="handleStreamError('proxy-stream')"
                        />
                        <div class="stream-url">http://localhost:3001/mjpeg/stream.mjpg</div>
                        <div id="proxy-status" class="status loading">等待加载...</div>
                        <button onclick="testProxyStream()">测试代理流</button>
                        <button onclick="refreshProxyStream()">刷新流</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API测试 -->
        <div class="test-section">
            <div class="test-title">🔌 API连接测试</div>
            <div class="api-section">
                <button onclick="testSystemStatus()">测试系统状态</button>
                <button onclick="testCamerasAPI()">测试摄像头API</button>
                <button onclick="testStreamURL()">测试流URL获取</button>
                <button onclick="testAllAPIs()">测试所有API</button>
                <div id="api-result" class="api-result">点击按钮开始测试API...</div>
            </div>
        </div>
        
        <!-- 系统信息 -->
        <div class="test-section">
            <div class="test-title">ℹ️ 系统信息</div>
            <div id="system-info">
                <p><strong>前端地址:</strong> http://localhost:3001</p>
                <p><strong>后端API:</strong> http://localhost:8080</p>
                <p><strong>MJPEG流:</strong> http://127.0.0.1:8161</p>
                <p><strong>测试时间:</strong> <span id="test-time"></span></p>
            </div>
        </div>
    </div>

    <script>
        // 更新测试时间
        document.getElementById('test-time').textContent = new Date().toLocaleString();
        
        // 流加载处理
        function handleStreamLoad(streamId) {
            const statusId = streamId.replace('-stream', '-status');
            const statusEl = document.getElementById(statusId);
            statusEl.className = 'status success';
            statusEl.textContent = '✅ 流加载成功!';
        }
        
        function handleStreamError(streamId) {
            const statusId = streamId.replace('-stream', '-status');
            const statusEl = document.getElementById(statusId);
            statusEl.className = 'status error';
            statusEl.textContent = '❌ 流加载失败';
        }
        
        // 测试直接流
        function testDirectStream() {
            const img = document.getElementById('direct-stream');
            const status = document.getElementById('direct-status');
            
            status.className = 'status loading';
            status.textContent = '正在加载直接流...';
            
            img.src = `http://127.0.0.1:8161/stream.mjpg?t=${Date.now()}`;
        }
        
        // 测试代理流
        function testProxyStream() {
            const img = document.getElementById('proxy-stream');
            const status = document.getElementById('proxy-status');
            
            status.className = 'status loading';
            status.textContent = '正在加载代理流...';
            
            img.src = `http://localhost:3001/mjpeg/stream.mjpg?t=${Date.now()}`;
        }
        
        // 刷新流
        function refreshDirectStream() {
            testDirectStream();
        }
        
        function refreshProxyStream() {
            testProxyStream();
        }
        
        // API测试函数
        async function testSystemStatus() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = '正在测试系统状态API...';
            
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();
                resultEl.textContent = `✅ 系统状态API测试成功:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultEl.textContent = `❌ 系统状态API测试失败: ${error.message}`;
            }
        }
        
        async function testCamerasAPI() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = '正在测试摄像头API...';
            
            try {
                const response = await fetch('/api/cameras');
                const data = await response.json();
                resultEl.textContent = `✅ 摄像头API测试成功:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultEl.textContent = `❌ 摄像头API测试失败: ${error.message}`;
            }
        }
        
        async function testStreamURL() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = '正在测试流URL获取...';
            
            try {
                // 模拟前端的getStreamUrl逻辑
                const response = await fetch('/api/cameras');
                const data = await response.json();
                const cameras = data.cameras || [];
                
                if (cameras.length > 0) {
                    const camera = cameras[0];
                    const streamUrl = camera.mjpeg_port ?
                        `http://127.0.0.1:${camera.mjpeg_port}/stream.mjpg` :
                        'http://127.0.0.1:8161/stream.mjpeg';
                    
                    resultEl.textContent = `✅ 流URL获取成功:\n摄像头: ${camera.id}\n流地址: ${streamUrl}`;
                } else {
                    resultEl.textContent = '⚠️ 没有找到摄像头配置';
                }
            } catch (error) {
                resultEl.textContent = `❌ 流URL获取失败: ${error.message}`;
            }
        }
        
        async function testAllAPIs() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = '正在测试所有API...\n';
            
            const tests = [
                { name: '系统状态', url: '/api/system/status' },
                { name: '摄像头列表', url: '/api/cameras' },
                { name: '报警列表', url: '/api/alerts' }
            ];
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url);
                    const data = await response.json();
                    resultEl.textContent += `✅ ${test.name}: 成功\n`;
                } catch (error) {
                    resultEl.textContent += `❌ ${test.name}: 失败 - ${error.message}\n`;
                }
            }
        }
        
        // 页面加载时自动测试
        window.onload = function() {
            // 延迟1秒后自动测试直接流
            setTimeout(() => {
                testDirectStream();
            }, 1000);
        };
    </script>
</body>
</html>
