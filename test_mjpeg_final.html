<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MJPEGæµæœ€ç»ˆæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }
        .stream-container {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .stream-item {
            flex: 1;
            min-width: 300px;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }
        .stream-header {
            background: #f8f9fa;
            padding: 10px;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        .stream-content {
            padding: 10px;
            text-align: center;
        }
        .stream-image {
            max-width: 100%;
            height: 200px;
            object-fit: cover;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .stream-url {
            font-size: 12px;
            color: #666;
            margin: 10px 0;
            word-break: break-all;
        }
        .status {
            padding: 8px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.loading {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
        .api-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .api-result {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ AIå®‰å…¨è§†è§‰ç³»ç»Ÿ - MJPEGæµæœ€ç»ˆæµ‹è¯•</h1>
        
        <!-- ç›´æ¥MJPEGæµæµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">ğŸ“¡ ç›´æ¥MJPEGæµæµ‹è¯•</div>
            <div class="stream-container">
                <div class="stream-item">
                    <div class="stream-header">åç«¯MJPEGæµ (ç«¯å£8161)</div>
                    <div class="stream-content">
                        <img 
                            id="direct-stream" 
                            class="stream-image" 
                            alt="Direct MJPEG Stream"
                            onload="handleStreamLoad('direct-stream')"
                            onerror="handleStreamError('direct-stream')"
                        />
                        <div class="stream-url">http://127.0.0.1:8161/stream.mjpg</div>
                        <div id="direct-status" class="status loading">ç­‰å¾…åŠ è½½...</div>
                        <button onclick="testDirectStream()">æµ‹è¯•ç›´æ¥æµ</button>
                        <button onclick="refreshDirectStream()">åˆ·æ–°æµ</button>
                    </div>
                </div>
                
                <div class="stream-item">
                    <div class="stream-header">å‰ç«¯ä»£ç†æµ (ç«¯å£3001)</div>
                    <div class="stream-content">
                        <img 
                            id="proxy-stream" 
                            class="stream-image" 
                            alt="Proxy MJPEG Stream"
                            onload="handleStreamLoad('proxy-stream')"
                            onerror="handleStreamError('proxy-stream')"
                        />
                        <div class="stream-url">http://localhost:3001/mjpeg/stream.mjpg</div>
                        <div id="proxy-status" class="status loading">ç­‰å¾…åŠ è½½...</div>
                        <button onclick="testProxyStream()">æµ‹è¯•ä»£ç†æµ</button>
                        <button onclick="refreshProxyStream()">åˆ·æ–°æµ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- APIæµ‹è¯• -->
        <div class="test-section">
            <div class="test-title">ğŸ”Œ APIè¿æ¥æµ‹è¯•</div>
            <div class="api-section">
                <button onclick="testSystemStatus()">æµ‹è¯•ç³»ç»ŸçŠ¶æ€</button>
                <button onclick="testCamerasAPI()">æµ‹è¯•æ‘„åƒå¤´API</button>
                <button onclick="testStreamURL()">æµ‹è¯•æµURLè·å–</button>
                <button onclick="testAllAPIs()">æµ‹è¯•æ‰€æœ‰API</button>
                <div id="api-result" class="api-result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•API...</div>
            </div>
        </div>
        
        <!-- ç³»ç»Ÿä¿¡æ¯ -->
        <div class="test-section">
            <div class="test-title">â„¹ï¸ ç³»ç»Ÿä¿¡æ¯</div>
            <div id="system-info">
                <p><strong>å‰ç«¯åœ°å€:</strong> http://localhost:3001</p>
                <p><strong>åç«¯API:</strong> http://localhost:8080</p>
                <p><strong>MJPEGæµ:</strong> http://127.0.0.1:8161</p>
                <p><strong>æµ‹è¯•æ—¶é—´:</strong> <span id="test-time"></span></p>
            </div>
        </div>
    </div>

    <script>
        // æ›´æ–°æµ‹è¯•æ—¶é—´
        document.getElementById('test-time').textContent = new Date().toLocaleString();
        
        // æµåŠ è½½å¤„ç†
        function handleStreamLoad(streamId) {
            const statusId = streamId.replace('-stream', '-status');
            const statusEl = document.getElementById(statusId);
            statusEl.className = 'status success';
            statusEl.textContent = 'âœ… æµåŠ è½½æˆåŠŸ!';
        }
        
        function handleStreamError(streamId) {
            const statusId = streamId.replace('-stream', '-status');
            const statusEl = document.getElementById(statusId);
            statusEl.className = 'status error';
            statusEl.textContent = 'âŒ æµåŠ è½½å¤±è´¥';
        }
        
        // æµ‹è¯•ç›´æ¥æµ
        function testDirectStream() {
            const img = document.getElementById('direct-stream');
            const status = document.getElementById('direct-status');
            
            status.className = 'status loading';
            status.textContent = 'æ­£åœ¨åŠ è½½ç›´æ¥æµ...';
            
            img.src = `http://127.0.0.1:8161/stream.mjpg?t=${Date.now()}`;
        }
        
        // æµ‹è¯•ä»£ç†æµ
        function testProxyStream() {
            const img = document.getElementById('proxy-stream');
            const status = document.getElementById('proxy-status');
            
            status.className = 'status loading';
            status.textContent = 'æ­£åœ¨åŠ è½½ä»£ç†æµ...';
            
            img.src = `http://localhost:3001/mjpeg/stream.mjpg?t=${Date.now()}`;
        }
        
        // åˆ·æ–°æµ
        function refreshDirectStream() {
            testDirectStream();
        }
        
        function refreshProxyStream() {
            testProxyStream();
        }
        
        // APIæµ‹è¯•å‡½æ•°
        async function testSystemStatus() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = 'æ­£åœ¨æµ‹è¯•ç³»ç»ŸçŠ¶æ€API...';
            
            try {
                const response = await fetch('/api/system/status');
                const data = await response.json();
                resultEl.textContent = `âœ… ç³»ç»ŸçŠ¶æ€APIæµ‹è¯•æˆåŠŸ:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultEl.textContent = `âŒ ç³»ç»ŸçŠ¶æ€APIæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        async function testCamerasAPI() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = 'æ­£åœ¨æµ‹è¯•æ‘„åƒå¤´API...';
            
            try {
                const response = await fetch('/api/cameras');
                const data = await response.json();
                resultEl.textContent = `âœ… æ‘„åƒå¤´APIæµ‹è¯•æˆåŠŸ:\n${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultEl.textContent = `âŒ æ‘„åƒå¤´APIæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }
        
        async function testStreamURL() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = 'æ­£åœ¨æµ‹è¯•æµURLè·å–...';
            
            try {
                // æ¨¡æ‹Ÿå‰ç«¯çš„getStreamUrlé€»è¾‘
                const response = await fetch('/api/cameras');
                const data = await response.json();
                const cameras = data.cameras || [];
                
                if (cameras.length > 0) {
                    const camera = cameras[0];
                    const streamUrl = camera.mjpeg_port ?
                        `http://127.0.0.1:${camera.mjpeg_port}/stream.mjpg` :
                        'http://127.0.0.1:8161/stream.mjpeg';
                    
                    resultEl.textContent = `âœ… æµURLè·å–æˆåŠŸ:\næ‘„åƒå¤´: ${camera.id}\næµåœ°å€: ${streamUrl}`;
                } else {
                    resultEl.textContent = 'âš ï¸ æ²¡æœ‰æ‰¾åˆ°æ‘„åƒå¤´é…ç½®';
                }
            } catch (error) {
                resultEl.textContent = `âŒ æµURLè·å–å¤±è´¥: ${error.message}`;
            }
        }
        
        async function testAllAPIs() {
            const resultEl = document.getElementById('api-result');
            resultEl.textContent = 'æ­£åœ¨æµ‹è¯•æ‰€æœ‰API...\n';
            
            const tests = [
                { name: 'ç³»ç»ŸçŠ¶æ€', url: '/api/system/status' },
                { name: 'æ‘„åƒå¤´åˆ—è¡¨', url: '/api/cameras' },
                { name: 'æŠ¥è­¦åˆ—è¡¨', url: '/api/alerts' }
            ];
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url);
                    const data = await response.json();
                    resultEl.textContent += `âœ… ${test.name}: æˆåŠŸ\n`;
                } catch (error) {
                    resultEl.textContent += `âŒ ${test.name}: å¤±è´¥ - ${error.message}\n`;
                }
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            // å»¶è¿Ÿ1ç§’åè‡ªåŠ¨æµ‹è¯•ç›´æ¥æµ
            setTimeout(() => {
                testDirectStream();
            }, 1000);
        };
    </script>
</body>
</html>
